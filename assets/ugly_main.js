function Person(e,a){this.b=s.gamma(e,a),this.M=.5,this.W=0,this.WM=0,this.WF=0,this.I=0,this.bednet=0,this.t=0,this.u=s.normal(params.u0,Math.sqrt(params.sigma)),this.repRate=function(){return 0==params.nu?this.WM>0?this.WF:0:params.alpha*Math.min(this.WF,1/params.nu*this.WM)},this.biteRate=function(){return this.a<108?this.a/108:1},this.react=function(){var e=1-(1-params.sN)*this.bedNet;this.I=immuneRK4Step(this.W,this.I);var a=poisson(.5*e*params.xi*this.biteRate()*params.L3*Math.exp(-1*params.theta*this.I)*this.b*params.dt),s=poisson(params.mu*this.WM*params.dt);this.WM+=a-s,a=poisson(.5*e*params.xi*this.biteRate()*params.L3*Math.exp(-1*params.theta*this.I)*this.b*params.dt),s=poisson(params.mu*this.WF*params.dt),this.WF+=a-s,this.M+=params.dt*(this.repRate()-params.gamma*this.M),this.W=this.WM+this.WF,this.t+=params.dt,this.a+=params.dt,this.W<0&&(this.W=0),this.WM<0&&(this.WM=0),this.WF<0&&(this.WF=0),this.I<0&&(this.I=0),this.M<0&&(this.M=0),(Math.random()<1-Math.exp(-1*params.tau*params.dt)||this.a>1200)&&(this.initialise(),this.a=0)},this.initialise=function(){this.W=0,this.WM=0,this.WF=0,this.I=0,this.M=0,this.bedNet=0,this.u=s.normal(params.u0,Math.sqrt(params.sigma))}}function Model(e){this.sU=0,this.sB=0,this.sN=0,this.people=[],this.n=e,this.bedNetInt=0,this.ts=[],this.Ms=[],this.Ws=[],this.Ls=[];for(var a=0;e>a;a++)this.people.push(new Person(params.a,params.b));this.saveOngoing=function(e,a,s,t){t=1-Math.exp(-t),this.ts.push(e),this.Ms.push(100*a),this.Ws.push(100*s),this.Ls.push(100*t)},this.L3=function(){for(var e=0,a=0,s=0;s<this.n;s++)e+=this.people[s].b*L3Uptake(this.people[s].M),a+=this.people[s].b;return e/=a,e*(1+this.bedNetInt*params.covN*(params.sN-1))*params.lbda*params.g/(params.sig+params.lbda*params.psi1)},this.prevalence=function(){for(var e=0,a=0;a<this.n;a++)e+=s.random()<1-Math.exp(-this.people[a].M);return e/this.n},this.aPrevalence=function(){for(var e=0,a=0;a<this.n;a++)e+=this.people[a].W>0;return e/this.n},this.MDAEvent=function(){for(var e=0;e<this.n;e++)s.normal(this.people[e].u,1)<0&&(this.people[e].M=params.mfPropMDA*this.people[e].M,this.people[e].WM=Math.floor(params.wPropMDA*this.people[e].WM),this.people[e].WF=Math.floor(params.wPropMDA*this.people[e].WF))},this.bedNetEvent=function(){params.sig=params.sig+params.lbda*params.dN*params.covN;for(var e=0;e<this.n;e++)this.people[e].bedNet=s.random()<params.covN?1:0},this.nRounds=function(){for(var e=[],a=0;a<this.Ms.length;a++)this.Ms[a]<1&&e.push(a);return Math.floor(12==params.mdaFreq?this.ts[e[0]]:2*this.ts[e[0]])},this.reduction=function(e){var a=6*e;return this.Ms[a]/this.Ms[0]},this.reductionYears=function(){for(var e=[],a=0;20>a;a++)e.push(this.reduction(a));return e},this.evolveAndSaves=function(e){var a,s=0,t=0,r=1200;this.bedNetInt=0;for(var i=0;i<this.n;i++)this.people[i].M=1;for(r=1200+params.nMDA*params.mdaFreq,a=1==params.IDAControl?1200+5*params.mdaFreq:2*r,console.log("mosquito species: ",params.mosquitoSpecies,"\n"),params.L3=5,console.log("0----------100\n-");12*e>s;){params.dt=960>s?12:1;for(var i=0;i<this.n;i++)this.people[i].react();s=this.people[0].t,params.L3=960>s?2:this.L3(),s%2==0&&s<Math.floor(s)+params.dt&&this.saveOngoing(s/12,this.prevalence(),this.aPrevalence(),params.L3),Math.floor(s)%Math.floor(12*e/10)==0&&s<Math.floor(s)+params.dt&&(console.log("-"),$("#test1").append(" p : "+this.prevalence()+" t : "+s/12)),s>=1200&&s<1200+params.dt&&(console.log("bednet event at ",s),this.bedNetEvent(),this.bedNetInt=1),s%params.mdaFreq==0&&s<Math.floor(s)+params.dt&&(s>1200&&r>=s?(this.MDAEvent(),setBR(!0),setVH(!0),setMu(!0)):(setBR(!1),setVH(!1),setMu(!1))),t++}this.Ws=this.Ws.slice(200,this.Ws.length),this.Ms=this.Ms.slice(200,this.Ms.length),this.Ls=this.Ls.slice(200,this.Ls.length);var o=this.ts[200];this.ts=math.subtract(this.ts.slice(200,this.ts.length),o)}}function NormSInv(e){var a,s,t,r=-39.6968302866538,i=220.946098424521,o=-275.928510446969,n=138.357751867269,l=-30.6647980661472,d=2.50662827745924,c=-54.4760987982241,m=161.585836858041,p=-155.698979859887,u=66.8013118877197,h=-13.2806815528857,v=-.00778489400243029,g=-.322396458041136,b=-2.40075827716184,S=-2.54973253934373,f=4.37466414146497,$=2.93816398269878,M=.00778469570904146,x=.32246712907004,y=2.445134137143,w=3.75440866190742,C=.02425,D=1-C;return 0>e||e>1?(console.error("NormSInv: Argument out of range."),t=0):C>e?(a=Math.sqrt(-2*Math.log(e)),t=(((((v*a+g)*a+b)*a+S)*a+f)*a+$)/((((M*a+x)*a+y)*a+w)*a+1)):e>D?(a=Math.sqrt(-2*Math.log(1-e)),t=-(((((v*a+g)*a+b)*a+S)*a+f)*a+$)/((((M*a+x)*a+y)*a+w)*a+1)):(a=e-.5,s=a*a,t=(((((r*s+i)*s+o)*s+n)*s+l)*s+d)*a/(((((c*s+m)*s+p)*s+u)*s+h)*s+1)),t}function SessionData(){}function ScenarioIndex(){}function clearSession(){bootbox.confirm("Are you sure you want to delete this session? This will remove all scenarios.",function(e){e&&(SessionData.deleteSession(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawScenarioPlot(),$("#scenario-title").html("Scenario Overview"))})}function scenarioComparisonSelectVisibility(){var e=SessionData.retrieveSession(),a=e&&e.scenarios?e.scenarios.length:0;a>0?($("#sel-comp-stat-div").show(),$("#sel-stat-group").show(),$("#about").popover({trigger:"manual"}),$("#about").popover("hide")):($("#sel-comp-stat-div").hide(),$("#sel-stat-group").hide(),$("#about").popover({animation:!0,title:"First time?",content:"Click here for overview and tutorial.",placement:"bottom",trigger:"focus"}),$("#about").popover("show"))}function scenarioRunStats(){var e=ScenarioIndex.getIndex(),a=SessionData.retrieveSession().scenarios[e],s=($.Deferred(),[]),t=[],r=[],s=a.results[0].ts,t=[],i=reductionStatsCalc(a,params.covMDA);t=i.doses,r=i.reduction,console.log(s),console.log(t),SessionData.storeStats({ts:s,prev_reds:r,doses:t,Ws:i.medW,Ms:i.medM,Ls:i.medL}),drawComparisonPlot()}function createScenarioBoxes(){var e=SessionData.retrieveSession(),a=ScenarioIndex.getIndex();n=e&&e.scenarios?e.scenarios.length:0,d3.select("#scenario-button-group").html(""),n>0&&d3.select("#scenario-button-group").append("h4").html("Select scenario to plot:");for(var s=0;n>s;s++)d3.select("#scenario-button-group").append("div").attr("class","btn btn-primary btn-lg btn-block ".concat(s==a?"active":"")).attr("id","scenario-button-"+s).attr("data-scenario-label",e.scenarios[s].label).attr("data-scenario",s).attr("aria-pressed",s==a).html(e.scenarios[s].label).on("click",function(){ScenarioIndex.setIndex($("#"+this.id).data("scenario")),drawScenarioPlot(),setmodelParams(),fixInput(),$("#close_scenario").html("Show Scenario"),$("#scenario-messages").html('<div class="alert alert-success alert-dismissible" role="alert">  '+$("#"+this.id).data("scenario-label")+" set </div>"),$(this).addClass("active").siblings().removeClass("active"),$("#download").removeClass("hidden"),$("#delete_scenario").removeClass("hidden").unbind().click(function(){bootbox.confirm("Are you sure you want to delete this scenario?",function(e){e&&(SessionData.deleteScenario(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawScenarioPlot(),$("#settings-modal").modal("hide"))})}),$("#settings-modal").modal("show"),$("#run_scenario").html(SessionData.ran(s)?"Display Scenario":"Run Scenario")});n>0&&(d3.select("#scenario-button-group").append("div").attr("class","divider"),d3.select("#scenario-button-group").append("div").attr("class","btn btn-danger btn-lg btn-block ").html("Clear Session").on("click",clearSession))}function drawScenarioPlot(){var e=ScenarioIndex.getIndex(),a=SessionData.retrieveSession().scenarios[e],s=$("#sel-stat").val();a?"mf"==s?timeSeriesPlot("microfilaraemia","mf prevalence (%)","Ms"):"ICT"==s?timeSeriesPlot("antigenaemia","antigen prevalence (%)","Ws"):"L3"==s&&timeSeriesPlot("L3 prevalence","larval prevalence in mosquito (%)","Ls"):Plotly.newPlot("map",[],[],{displayModeBar:!1})}function timeSeriesPlot(e,a,s){for(var t=[],r=ScenarioIndex.getIndex(),i=SessionData.retrieveSession().scenarios[r].results,o=SessionData.retrieveSession().scenarios[r].stats[s],n=i.length,l=0;n>l;l++)c={type:"scatter",x:i[l].ts,y:i[l][s],mode:"lines",hoverinfo:"none",line:{color:"rgb(200, 200, 200)",width:1,opacity:.3}},t.push(c);if(c={type:"scatter",x:i[0].ts,y:o,mode:"lines+markers",name:"median",line:{color:"rgb(0, 0, 200)",width:2,opacity:1}},t.push(c),"Ms"==s||"Ws"==s){var d="Ms"==s?1:2,c={x:i[0].ts,y:Array.apply(null,{length:i[0].ts.length}).map(Number.call,function(){return d}),mode:"lines",name:"threshold",text:"pre-TAS threshold",hoverinfo:"text",line:{color:"rgb(0, 0, 0)",dash:"dot",width:4}};t.push(c)}var m={autosize:!0,showlegend:!1,title:e,hovermode:"closest",textposition:"top right",xaxis:{title:"time since start of intervention (yrs)",showgrid:!0,zeroline:!1},yaxis:{title:a,showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}};Plotly.newPlot("map",t,m,{displayModeBar:!1})}function drawComparisonPlot(){var e=SessionData.retrieveSession();if(e.scenarios.length>0){var a=$("#sel-comp-stat").val();"doses"==a?drawDosesTimeLine():"rounds"==a?drawMapBoxPlot():"prev"==a&&drawPrevalenceTimeLine()}else Plotly.newPlot("map-boxplot",[],{height:10,width:10},{displayModeBar:!1})}function drawDosesTimeLine(){for(var e=ScenarioIndex.getIndex(),a=SessionData.retrieveSession(),s=a.scenarios.length,t=[],r={autosize:!0,title:"Doses per year",xaxis:{title:"time since start of intervention (yrs)",showgrid:!0,zeroline:!1},yaxis:{title:"doses per 100,000",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},i=0;s>i;i++){var o=a.scenarios[i].stats.ts,n=a.scenarios[i].stats.doses,l={x:o,y:n,mode:"lines+markers",name:a.scenarios[i].label};t.push(l)}console.log(t),Plotly.newPlot("map-boxplot",t,r,{displayModeBar:!1}),ScenarioIndex.setIndex(e)}function drawPrevalenceTimeLine(){for(var e=ScenarioIndex.getIndex(),a=SessionData.retrieveSession(),s=a.scenarios.length,t=[],r={autosize:!0,title:"Reduction in Prevalence (%)",xaxis:{title:"time since start of intervention (yrs)",showgrid:!0,zeroline:!1},yaxis:{title:"Reduction in prevalence (%)",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},i=0;s>i;i++){var o=a.scenarios[i].stats.ts,n=a.scenarios[i].stats.prev_reds,l={x:o,y:n,mode:"lines+markers",name:a.scenarios[i].label};t.push(l)}Plotly.newPlot("map-boxplot",t,r,{displayModeBar:!1}),ScenarioIndex.setIndex(e)}function drawMapBoxPlot(){for(var e=SessionData.retrieveSession(),a=e.scenarios.length,s=[],t=0;a>t;t++){var r={y:SessionData.nRounds(t),type:"box",name:e.scenarios[t].label};s.push(r)}var i={autosize:!0,title:"No. rounds to below 1% microfilariaemia",xaxis:{title:"",showgrid:!1,zeroline:!1},yaxis:{title:"No. rounds",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}};Plotly.newPlot("map-boxplot",s,i,{displayModeBar:!1})}function median(e){e.sort(function(e,a){return e-a});var a=Math.floor(e.length/2);return e.length%2?e[a]:(e[a-1]+e[a])/2}function numberWithCommas(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")}function runMapSimulation(){setInputParams({nMDA:40});var e=$("#inputScenarioLabel").val(),a=+$("#runs").val(),s=[],t=0;fixInput(),$("#map-progress-bar").css("width","0%"),$("#map-progress-bar").show();var r=setInterval(function(){$("#map-progress-bar").css("width",+(100*t/a)+"%");var i=new Model(800);i.evolveAndSaves(120),s.push(SessionData.convertRun(i,endemicity)),$("#roundsTest").html(100*t/a+"%"),t==a?($("#map-progress-bar").hide(),clearInterval(r),SessionData.storeResults(s,e),scenarioRunStats(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawScenarioPlot(),$("#scenario-title").html(e+" Overview"),$("#settings-modal").modal("hide")):t+=1},10)}function reductionStatsCalc(e,a){for(var s,t=e.results.length,r=e.results[0].ts.length,i=Array(r),o=Array(r),n=Array(r),l=Array(r),d=Array(r),c=6==params.mdaFreq?2:1,m=0;r>m;m++){i[m]=0,o[m]=0,mM=[],mW=[],mL=[];for(var p=0;t>p;p++)s=prev=e.results[p].Ms[0],red=e.results[p].Ms[m]/s,prev=e.results[p].Ms[m],mM.push(e.results[p].Ms[m]),mW.push(e.results[p].Ws[m]),mL.push(e.results[p].Ls[m]),i[m]+=red,prev>1&&(o[m]+=1e5*a*c);i[m]=100*(1-i[m]/t),o[m]=o[m]/t,n[m]=median(mM),l[m]=median(mW),d[m]=median(mL)}return{reduction:i,doses:o,medM:n,medW:l,medL:d}}function modalConfirmation(e){SessionData.ran(e)?(ScenarioIndex.setIndex(e),$("#settings-modal").modal("hide")):runSimClick()}function addScenarioButton(){var e=SessionData.numScenarios();ScenarioIndex.setIndex(e),SessionData.createNewSession(),$("#scenario-messages").html(""),$("#delete_scenario").addClass("hidden"),$("#download").addClass("hidden"),$("#settings-modal").modal("show"),$("#close_scenario").html("close"),fixInput(!1)}function runSimClick(){runMapSimulation()}function changeLabel(){var e=$("#inputScenarioLabel").val(),a=ScenarioIndex.getIndex(),s=SessionData.retrieveSession();s.scenarios[a].label=e,SessionData.storeSession(s),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawScenarioPlot(),$("#scenario-label-button").hide(),$("#scenario-title").html(e+" Overview"),$("#scenario-messages").html('<div class="alert alert-success alert-dismissible" role="alert">  '+e+" set </div>")}function fixInput(e){var a=ScenarioIndex.getIndex();null==e&&(e=!0),e?($("#MDACoverage").slider("disable"),$("#bedNetCoverage").slider("disable"),$("#insecticideCoverage").slider("disable"),$("#Microfilaricide").slider("disable"),$("#Macrofilaricide").slider("disable"),$("#runs").slider("disable"),$("#sysAdherence").slider("disable"),$("#run_scenario").hide(),$("input:radio[name=mdaSixMonths]").attr("disabled",!0),$("input:radio[name=mdaRegimenRadios]").attr("disabled",!0),$("input:radio[name=speciesRadios]").attr("disabled",!0),$("#endemicity").slider("disable"),$("#labelEditable").attr("is",!0)):($("#runs").slider("enable"),$("#MDACoverage").slider("enable"),$("#sysAdherence").slider("enable"),$("#bedNetCoverage").slider("enable"),$("#insecticideCoverage").slider("enable"),$("#Microfilaricide").slider("enable"),$("#Macrofilaricide").slider("enable"),$("#endemicity").slider("enable"),$("#run_scenario").show(),$("input:radio[name=mdaSixMonths]").attr("disabled",!1),$("input:radio[name=mdaRegimenRadios]").attr("disabled",!1),$("#inputScenarioLabel").attr("disabled",!1).val("Scenario "+(a+1)),$("input:radio[name=speciesRadios]").attr("disabled",!1),$("#labelEditable").attr("is",!1)),5==$("input[name=mdaRegimenRadios]:checked").val()?$("#custom-regimen-sliders").show():$("#custom-regimen-sliders").hide(),$("#scenario-label-button").hide()}function setmodelParams(e){null==e&&(e=!1);var a=ScenarioIndex.getIndex(),s=SessionData.retrieveSession(),t=s.scenarios[a].params.inputs;return $("#inputScenarioLabel").val(s.scenarios[a].label),$("#inputMDARounds").val(t.mda),$("#sysAdherence").val(t.rho),$("#runs").slider("setValue",+t.runs),$("#MDACoverage").slider("setValue",+t.coverage),$("#endemicity").slider("setValue",+t.endemicity),$("#bedNetCoverage").slider("setValue",+t.covN),$("#insecticideCoverage").slider("setValue",+t.v_to_hR),$("input:radio[name=mdaSixMonths]").filter("[value="+t.mdaSixMonths+"]").prop("checked",!0),$("input:radio[name=mdaRegimenRadios]").filter("[value="+t.mdaRegimen+"]").prop("checked",!0),$("input:radio[name=speciesRadios]").filter("[value="+t.species+"]").prop("checked",!0),$("#Microfilaricide").slider("setValue",+t.microfilaricide),$("#Macrofilaricide").slider("setValue",+t.macrofilaricide),{mda:$("#inputMDARounds").val(),mdaSixMonths:$("input:radio[name=mdaSixMonths]:checked").val(),endemicity:$("#endemicity").val(),coverage:$("#MDACoverage").val(),covN:$("#bedNetCoverage").val(),v_to_hR:$("#insecticideCoverage").val(),vecCap:$("#vectorialCapacity").val(),vecComp:$("#vectorialCompetence").val(),vecD:$("#vectorialDeathRate").val(),mdaRegimen:$("input[name=mdaRegimenRadios]:checked").val(),rho:$("#sysAdherence").val(),rhoBComp:$("#brMda").val(),rhoCN:$("#bedNetMda").val(),species:$("input[name=speciesRadios]:checked").val(),macrofilaricide:$("#Macrofilaricide").val(),microfilaricide:$("#Microfilaricide").val()}}function download(){var e=SessionData.retrieveSession().scenarios[ScenarioIndex.getIndex()].label,a=SessionData.retrieveSession().scenarios[ScenarioIndex.getIndex()].results,s="time (years),run,microfilaraemia,antigenaemia,mosquito prevalence",t="data:text/csv;charset=utf-8,"+s+"\n";a.forEach(function(e,a){e.ts.forEach(function(s,r){dataString=e.ts[r]+","+a+","+e.Ms[r]+","+e.Ws[r]+","+e.Ls[r],t+=dataString+"\n"})});var r=encodeURI(t),i=document.createElement("a");i.setAttribute("href",r),i.setAttribute("download",e+".csv"),document.body.appendChild(i),i.click()}function toggle(e,a){var s=$(a);s.prop("checked")?$(e).show():$(e).hide()}function toggleOff(e,a){var s=$(a);s.prop("checked")?$(e).hide():$(e).show()}function modelParams(){return{mda:$("#inputMDARounds").val(),mdaSixMonths:$("input:radio[name=mdaSixMonths]:checked").val(),endemicity:$("#endemicity").val(),coverage:$("#MDACoverage").val(),covN:$("#bedNetCoverage").val(),v_to_hR:$("#insecticideCoverage").val(),vecCap:$("#vectorialCapacity").val(),vecComp:$("#vectorialCompetence").val(),vecD:$("#vectorialDeathRate").val(),mdaRegimen:$("input[name=mdaRegimenRadios]:checked").val(),rho:$("#sysAdherence").val(),rhoBComp:$("#brMda").val(),rhoCN:$("#bedNetMda").val(),species:$("input[name=speciesRadios]:checked").val(),macrofilaricide:$("#Macrofilaricide").val(),microfilaricide:$("#Microfilaricide").val(),runs:$("#runs").val()}}function mdaDrugName(e){var a="";switch(e){case"1":a="albendazole + ivermectin";break;case"2":a="albendazole + diethylcarbamazine";break;case"3":a="ivermectin";break;case"4":a="ivermectin + diethylcarbamazine + albendazole";break;case"5":a="custom regimen with "+$("#Macrofilaricide").val()+"% macrofilariae reduction, and "+$("#Microfilaricide").val()+"% microfilariae reduction"}return a}function paramSummary(e){void 0===e&&(e=""),str=paramSummaryText(!1),$("#model"+e+" #parameters-summary").text(str)}function paramSummaryText(e){e=void 0!==e?e:!1;var a=modelParams(),s="Parameters used in this scenario are : ";return e===!1?(s+=a.mda?a.mda+" rounds ":"no MDA rounds ",a.mda&&(s+="of "+mdaDrugName(a.mdaRegimen)+" MDA "),a.mda&&(s+="True"==a.mdaSixMonths?"occuring every six months ":"occuring annually "),s+=a.mda?"with "+a.coverage+"% coverage. ":". "):(s+=mdaDrugName(a.mdaRegimen),s+=a.mdaSixMonths?" occuring every six months ":" occuring annually ",s+="with "+a.coverage+"% coverage. "),s+="Prevalence of microfilariaemia is on average "+a.endemicity+"%. ",s+="Bed-net coverage is "+a.covN+"% and ",s+="insecticide coverage is "+a.v_to_hR+"%. "}function multiSimCompute(e){void 0===e&&(e=""),setInputParams();var a=new Model(800);a.evolveAndSaves(120),$("#model"+e+" #test-data-result").html(a),$("#pleaseWaitDialog").modal("hide");var s=+$("#model"+e+" #multiSim").val();$(".progress-bar").css("width","0%").attr("aria-valuenow",0);var t={x:a.ts,y:a.Ms,type:"scatter",name:"run "+s},r={x:a.ts,y:a.Ws,type:"scatter",name:"run "+s},i={x:a.ts,y:a.Ls,type:"scatter",name:"run "+s},o=jQuery.extend({},layout);o.title="microfilariaemia",Plotly.newPlot("model_"+e+"_chart_mf",[t],o,{displayModeBar:!1}),$("#model_"+e+"_chart_mf,#model_"+e+"_chart_wb,#model_"+e+"_chart_L3").on("plotly_beforehover",function(){return!1});var n=jQuery.extend({},layout);n.title="antigenaemia",Plotly.newPlot("model_"+e+"_chart_wb",[r],n,{displayModeBar:!1});var l=jQuery.extend({},layout);l.title="mosquito",Plotly.newPlot("model_"+e+"_chart_L3",[i],l,{displayModeBar:!1}),addNewSim($("#model"+e+" #multiSim").val()-1,e,s)}function addNewSim(e,a,s){if(void 0===a&&(a=""),e>0){setInputParams();var t=new Model(800);t.evolveAndSaves(120);var r={x:t.ts,y:t.Ms,type:"scatter",name:"run "+e},i={x:t.ts,y:t.Ws,type:"scatter",name:"run "+e},o={x:t.ts,y:t.Ls,type:"scatter",name:"run "+e};Plotly.addTraces("model_"+a+"_chart_mf",r),Plotly.addTraces("model_"+a+"_chart_wb",i),Plotly.addTraces("model_"+a+"_chart_L3",o),$(".progress-bar").css("width",100*(s-e+1)/s+"%").attr("aria-valuenow",100*(s-e+1)/s),e--,setTimeout(function(){addNewSim(e,a,s)},500)}else $("#model"+a+" #multiSimLoading").hide()}function runSimulation(e){if(paramSummary(e),$("#model"+e+" #mutliSimCheckBox").prop("checked"))$("#model"+e+" #multiSimLoading").show(),multiSimCompute(e);else{setInputParams();var a=new Model(800);a.evolveAndSaves(120);var s={x:a.ts,y:a.Ms,type:"scatter",name:"microfilariaemia"},t={x:a.ts,y:a.Ws,type:"scatter",name:"antigenaemia"},r={x:a.ts,y:a.Ls,type:"scatter",name:"mosquito"},i=[s,t,r];layout.title="Time Series",Plotly.newPlot("plotlyChart"+e,i,layout,{displayModeBar:!1})}}var s=new Random;immuneRK4Step=function(e,a){var s=params.dt*(e-params.z*a),t=params.dt*(e-params.z*(a+.5*s)),r=params.dt*(e-params.z*(a+.5*t)),i=params.dt*(e-params.z*(a+r));return a+.1666667*(s+2*t+2*r+i)},L3Uptake=function(e){return 0==params.mosquitoSpecies?params.kappas1*Math.pow(1-Math.exp(-params.r1*e/params.kappas1),2):params.kappas1*(1-Math.exp(-params.r1*e/params.kappas1))},expTrunc=function(e,a){return-1/e*Math.log(1-Math.random()*(1-Math.exp(-e*a)))},poisson=function(e){var a=Math.exp(-e),s=1,t=0;do t++,s*=Math.random();while(s>a);return t-1},setBR=function(e){e?(params.lbda=params.lbdaR*params.lbda_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2):(params.lbda=params.lbda_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2)},setVH=function(e){e?(params.v_to_h=params.v_to_hR*params.v_to_h_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2):(params.v_to_h=params.v_to_h_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2)},setMu=function(e){params.sig=e?params.sigR:params.sig_original};var params={riskMu1:1,riskMu2:1,riskMu3:1,shapeRisk:.065,mu:.0104,theta:0,gamma:.1,alpha:.58,lbda:10,v_to_h:9,kappas1:4.395,r1:.055,tau:.00167,z:0,nu:0,L3:0,g:.37,sig:5,psi1:.414,psi2:.32,dt:1,lbdaR:1,v_to_hR:1,nMDA:5,mdaFreq:12,covMDA:.65,s2:.00275,mfPropMDA:.05,wPropMDA:.45,rho:.999,mosquitoSpecies:0,rhoBU:0,aWol:0,sigR:5,covN:0,sysCompN:.99,rhoCN:0,IDAControl:0};params.lbda_original=params.lbda,params.v_to_h_original=params.v_to_h,params.sig_original=params.sig,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2,params.a=params.shapeRisk,params.b=1/params.a,params.sN=.03,params.dN=.41,params.sigma=params.rho/(1-params.rho),params.u0=-NormSInv(params.covMDA)*Math.sqrt(1+params.sigma),setPropMDA=function(e){ps=modelParams(),chis=[.99,.95,.99,1,+ps.microfilaricide/100,.99],taus=[.35,.55,.1,1,+ps.macrofilaricide/100,.1],params.mfPropMDA=1-chis[+e-1],params.wPropMDA=1-taus[+e-1]},closest=function(e,a){for(var s,t=0,r=a.length-1;r-t>1;)s=Math.floor((t+r)/2),a[s]<e?t=s:r=s;return e-a[t]>a[r]-e?r:t},setVHFromPrev=function(e,a){var s,t,r=[3.66666667,4,4.33333333,4.66666667,5,5.55555556,6.11111111,6.66666667,7.22222222,7.77777778,8.33333333,8.88888889,9.44444444,10],o=[2,2.33333333,2.66666667,3,3.33333333,3.66666667,4,4.55555556,5.11111111,5.66666667,6.22222222,6.77777778,7.33333333,7.88888889,8.44444444,9],n=[.06232983,.08068697,.07112745,.07718782,.09405936,.09882859,.11038997,.11982386,.12751358,.13604286,.14459468,.15150072,.15736517,.16302997],l=[.0472584,.05289496,.05937815,.06394662,.0715854,.08006637,.09306863,.11225442,.1267763,.13999753,.15040748,.16114762,.16863057,.17532108,.1827041,.18676246];return 0===a?(s=r,t=n):(s=o,t=l),i=closest(e,t),s[i]},setInputParams=function(e){ps=modelParams(),params.inputs=ps,params.runs=+ps.runs,params.nMDA=e&&e.nMDA?e.nMDA:+ps.mda,params.mdaFreq="True"===ps.mdaSixMonths?6:12;var a=e&&e.endemicity?e.endemicity/100:ps.endemicity/100,s=ps.species;params.v_to_h=+setVHFromPrev(a,+s),params.covMDA=+(ps.coverage/100),params.covN=+(ps.covN/100),params.v_to_hR=1-+(ps.v_to_hR/100),params.vecCap=+ps.vecCap,params.vecComp=+ps.vecComp,params.vecD=+ps.vecD,setPropMDA(+ps.mdaRegimen),params.rho=+ps.rho,params.rhoBComp=+ps.rhoBComp,params.rhoCN=+ps.rhoCN,params.species=+ps.species,params.mosquitoSpecies=params.species,params.shapeRisk=0==params.species?.065:.08,params.lbda_original=params.lbda,params.v_to_h_original=params.v_to_h,params.sig_original=params.sig,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2,params.a=params.shapeRisk,params.b=1/params.a,params.sigma=params.rho/(1-params.rho),params.u0=-NormSInv(params.covMDA)*Math.sqrt(1+params.sigma)},plot=function(e,a,s,t){a.unshift("worm_burden"),s.unshift("mf_burden"),t.unshift("L3"),e.unshift("tx"),c3.generate({bindto:"#chart",data:{xs:{worm_burden:"tx",mf_burden:"tx",L3:"tx"},columns:[e,a,s,t],names:{worm_burden:"Worm burden",mf_burden:"mf burden",L3:"L3 density"}},axis:{x:{label:"time (years)",tick:{fit:!1}},y:{label:"Prevalence",min:0}},legend:{position:"right"},zoom:{enabled:!0},type:"spline"})};var glob_data,glob_prevs;SessionData.storeResults=function(e,a){var s=JSON.parse(localStorage.getItem("sessionData"));(null==s||null==s.scenarios)&&(s={scenarios:[]}),null==a&&(a="Scenario "+(ScenarioIndex.getIndex()+1));var t={params:params,results:e,label:a},r=ScenarioIndex.getIndex();s.scenarios[r]=t,toStore=JSON.stringify(s);try{localStorage.setItem("sessionData",toStore)}catch(i){alert("Too many scenarios to store. Try deleting some.")}return s},SessionData.storeSession=function(e){toStore=JSON.stringify(e),localStorage.setItem("sessionData",toStore)},SessionData.storeStats=function(e){var a=JSON.parse(localStorage.getItem("sessionData")),s=ScenarioIndex.getIndex();a.scenarios[s].stats=e,toStore=JSON.stringify(a),localStorage.setItem("sessionData",toStore)},SessionData.createNewSession=function(){var e=JSON.parse(localStorage.getItem("sessionData"));(null==e||null==e.scenarios)&&(e={scenarios:[]});var a={params:params,results:[]},s=ScenarioIndex.getIndex();e.scenarios[s]=a,toStore=JSON.stringify(e)},SessionData.deleteSession=function(){localStorage.setItem("sessionData",null)},SessionData.retrieveSession=function(){var e=JSON.parse(localStorage.getItem("sessionData"));return e&&e.scenarios&&e.scenarios[0]&&e.scenarios[0].label?e:(e={scenarios:[]},toStore=JSON.stringify(e),localStorage.setItem("sessionData",toStore),e)},SessionData.numScenarios=function(){var e=SessionData.retrieveSession();return null==e||null==e.scenarios?0:e.scenarios.length},SessionData.convertRun=function(e,a){return{ts:e.ts,Ms:e.Ms,Ws:e.Ws,Ls:e.Ls,reductionYears:e.reductionYears(),nRounds:e.nRounds(),endemicity:a}},SessionData.nRounds=function(e){for(var a=SessionData.retrieveSession(),s=a.scenarios[e],t=s.results.length,r=[],i=0;t>i;i++)r.push(s.results[i].nRounds);return r},SessionData.reductions=function(e,a,s){var t=SessionData.retrieveSession(),r=t.scenarios[e],i=r.results.length;red=0;for(var o=0,n=0;i>n;n++)s?r.results[n].endemicity==s&&(red+=r.results[n].reductionYears[a],o+=1):(red+=r.results[n].reductionYears[a],o+=1);return red/o},SessionData.ran=function(e){var a=SessionData.retrieveSession();if(!a)return!1;if(!a.scenarios[e])return!1;var s=a.scenarios[e].results;return s.length>0?!0:!1},SessionData.deleteScenario=function(){var e=ScenarioIndex.getIndex(),a=SessionData.retrieveSession();a.scenarios.splice(e,1);var s=JSON.stringify(a);localStorage.setItem("sessionData",s),ScenarioIndex.setIndex(0)},ScenarioIndex.getIndex=function(){return+localStorage.getItem("scenarioIndex")},ScenarioIndex.setIndex=function(e){try{var a=SessionData.retrieveSession(),s=a.scenarios[e];params=s.params,$("#scenario-title").html(a.scenarios[e].label+" Overview")}catch(t){}return localStorage.setItem("scenarioIndex",e)},$(document).ready(function(){$("#map").width();ScenarioIndex.setIndex(0),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawScenarioPlot(),$("#map-progress-bar").hide(),$("#sel-comp-stat").change(drawComparisonPlot),$("#sel-stat").change(drawScenarioPlot),$("#add-new-scenario").on("click",addScenarioButton),$("#run_scenario").on("click",modalConfirmation),$("#inputScenarioLabel").on("input",function(){"true"==$("#labelEditable").attr("is")&&$("#scenario-label-button").show()}),$("#scenario-label-button").on("click",changeLabel),$("#download").on("click",download),$(".desc").hide(),$("#desc1").show(),$('input:radio[name="mdaRegimenRadios"]').click(function(){console.log(this);var e=$(this).val();$("small.desc").hide(),$("#desc"+e).show()})});var layout={title:"Time-series",xaxis:{title:"Time since start of intervention (yrs)",showgrid:!1,zeroline:!1},yaxis:{title:"Prevalence",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}};$(document).ready(function(){tabCounter=1,roundsScenarioCounter=1,$("#set-mda-regimen").click(function(){$("#mda-table-box .alert").alert("close");var e=$("#mda-form").html(),a=$("#coverage-form").html().replace("%",""),s=!1;if("IVM + ALB"==e)$("#mdaRegimenRadios1").prop("checked",!0);else if("DEC + ALB"==e)$("#mdaRegimenRadios2").prop("checked",!0);else{var t=$("#new-alert").html(),r=modelParams();$("#mda-table-box").append(t),$("#mda-table-box .alert").addClass("alert-warning").append("<strong> Warning! </strong> MDA regimen was not set. Current regimen is "+mdaDrugName(r.mdaRegimen)+". See settings -> MDA tab for details."),s=!0}if($("#MDACoverage").slider("setValue",+a),0==s){var t=$("#new-alert").html();$("#mda-table-box").append(t),$("#mda-table-box .alert").addClass("alert-success").append("<strong> Success! </strong> MDA parameters set. See settings -> MDA tab for details.")}}),$("#test-data").click(function(){if(paramSummary(),$("#pleaseWaitDialog").modal("show"),$("#model #mutliSimCheckBox").prop("checked"))$("#model #multiSimLoading").show(),multiSimCompute();else{setInputParams();var e=new Model(800);e.evolveAndSaves(120),console.log("No. rounds: ",e.nRounds());var a={x:e.ts,y:e.Ms,type:"scatter",name:"microfilariaemia"},s={x:e.ts,y:e.Ws,type:"scatter",name:"antigenaemia"},t={x:e.ts,y:e.Ls,type:"scatter",name:"mosquito"},r=[a,s,t];layout.title="Time Series",Plotly.newPlot("plotlyChart",r,layout,{displayModeBar:!1}),$("#pleaseWaitDialog").modal("hide")}}),$("#reset-rounds").click(function(){Plotly.newPlot("boxplotChart",[]),roundsScenarioCounter=1,$("#rounds-scenario-accordion").html("")}),$("#run-rounds").click(function(){$("#rounds-progress-bar").show(),$("#roundsTest").show(),$("#rounds-progress-bar-bar").css("width","100%").attr("aria-valuenow",100),$("#rounds-progress-bar").css("width","0%"),setInputParams(),params.nMDA=40;var e=$("#roundSims").val(),a=[],s=0,t=setInterval(function(){$("#rounds-progress-bar").css("width",+(100*s/e)+"%");var r=new Model(800);if(r.evolveAndSaves(120),a.push(r.nRounds()),$("#roundsTest").html(100*s/e+"%"),s==e){$("#rounds-progress-bar").hide(),$("#roundsTest").hide(),clearInterval(t);var i={title:"No. rounds to below 1% microfilariaemia",xaxis:{title:"",showgrid:!1,zeroline:!1},yaxis:{title:"No. rounds",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},o={y:a,type:"box",name:"scenario "+roundsScenarioCounter};1==roundsScenarioCounter?Plotly.newPlot("boxplotChart",[o],i,{displayModeBar:!1}):Plotly.addTraces("boxplotChart",[o]),roundsScenarioCounter+=1}else s+=1},10),r=$("#new-scenario-accordian").html();$("#rounds-scenario-accordion").append(r),$("#rounds-scenario-accordion #headingOne").attr("id","heading"+roundsScenarioCounter),$("#rounds-scenario-accordion #heading"+roundsScenarioCounter+" a").attr("href","#collapse"+roundsScenarioCounter).attr("aria-controls","collapse"+roundsScenarioCounter).html("Scenario "+roundsScenarioCounter),$("#rounds-scenario-accordion #collapseOne").attr("id","collapse"+roundsScenarioCounter),$("#collapse"+roundsScenarioCounter).attr("aria-labelledby","heading"+roundsScenarioCounter),$("#collapse"+roundsScenarioCounter+" .panel-body").html(paramSummaryText(!0))}),$("#home a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#vector a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#mda a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#rounds a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#model a").click(function(e){e.preventDefault(),$(this).tab("show")
}),$("#adherence a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#test a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#plus").click(function(){var e=$("<div role='tabpanel' class='tab-pane' id='model"+tabCounter+"'></div>"),a=$("#new-tab").html();$(".tab-content").append(e),$("div.tab-pane#model"+tabCounter).html(a);var s=$("<li role='presentation' "+tabCounter+"><a href='#model"+tabCounter+"' aria-controls='model' role='tab' data-toggle='tab'><button class='close closeTab' type='button' >x</button>Scenario "+tabCounter+" </a></li>");$("#nav-tabs li:last").prev().after(s),$("#model"+tabCounter+" #plotlyChart").attr("id","plotlyChart"+tabCounter),$("#model"+tabCounter+" #chart_mf").attr("id","model_"+tabCounter+"_chart_mf"),$("#model"+tabCounter+" #chart_wb").attr("id","model_"+tabCounter+"_chart_wb"),$("#model"+tabCounter+" #chart_L3").attr("id","model_"+tabCounter+"_chart_L3"),$("#model"+tabCounter+" #multiSim").slider(),$("#model"+tabCounter+" #multiSimSliderDiv").hide(),$("#model"+tabCounter+" #multiSimLoading").hide(),$("#model"+tabCounter+" #mutliSimCheckBox").data("tabIndex",tabCounter),$("#model"+tabCounter+" #simulation-title").html("Scenario "+tabCounter),$("#model"+tabCounter+" #mutliSimCheckBox").bind("click",function(){var e=$(this).data().tabIndex;toggle("#model"+e+" .multiSimGroup",this),toggleOff("#model"+e+" .singleSimGroup",this)}),$("#model"+tabCounter+" #test-data").data("tabIndex",tabCounter),$("#model"+tabCounter+" #test-data").bind("click",function(){var e=$(this).data();runSimulation(e.tabIndex)}),$(".closeTab").bind("click",function(){var e=$(this).parent().attr("href");$(this).parent().parent().remove(),$("#myTab a:last").tab("show"),$(e).remove()}),$("a#model"+tabCounter+" button").data("tabIndex",tabCounter),$('.nav-tabs a[href="#model'+tabCounter+'"]').tab("show"),tabCounter++}),$("#regimen-radio").bind("click",function(){5==$("input[name=mdaRegimenRadios]:checked").val()?$("#custom-regimen-sliders").show():$("#custom-regimen-sliders").hide()}),$("#custom-regimen-sliders").hide(),$("#Macrofilaricide").slider({}),$("#Microfilaricide").slider({}),$("#sysAdherence").slider({}),$("#brMda").slider({}),$("#bedNetMda").slider({}),$("#endemicity").slider({formatter:function(e){return e+"%"}}),$("#roundSims").slider({}),$("#MDACoverage").slider({formatter:function(e){return e+"%"}}),$("#bedNetCoverage").slider({formatter:function(e){return e+"%"}}),$("#insecticideCoverage").slider({formatter:function(e){return e+"%"}}),$("#multiSim").slider(),$("#vectorialCapacity").slider(),$("#vectorialCompetence").slider(),$("#vectorialDeathRate").slider(),$("#multiSimSliderDiv").hide(),$("#multiSimLoading").hide(),$("#rounds-progress-bar").hide(),$("#runs").slider({}),$("#termsModal").modal({show:!0,backdrop:"static",keyboard:!1})});
