function Person(a,b){this.b=s.gamma(a,b),this.M=.5,this.W=0,this.WM=0,this.WF=0,this.I=0,this.bednet=0,this.t=0,this.u=s.normal(params.u0,Math.sqrt(params.sigma)),this.repRate=function(){return 0==params.nu?this.WM>0?this.WF:0:params.alpha*Math.min(this.WF,1/params.nu*this.WM)},this.biteRate=function(){return this.a<108?this.a/108:1},this.react=function(){var a=1-(1-params.sN)*this.bedNet;this.I=immuneRK4Step(this.W,this.I);var b=poisson(.5*a*params.xi*this.biteRate()*params.L3*Math.exp(-1*params.theta*this.I)*this.b*params.dt),c=poisson(params.mu*this.WM*params.dt);this.WM+=b-c,b=poisson(.5*a*params.xi*this.biteRate()*params.L3*Math.exp(-1*params.theta*this.I)*this.b*params.dt),c=poisson(params.mu*this.WF*params.dt),this.WF+=b-c,this.M+=params.dt*(this.repRate()-params.gamma*this.M),this.W=this.WM+this.WF,this.t+=params.dt,this.a+=params.dt,this.W<0&&(this.W=0),this.WM<0&&(this.WM=0),this.WF<0&&(this.WF=0),this.I<0&&(this.I=0),this.M<0&&(this.M=0),(Math.random()<1-Math.exp(-1*params.tau*params.dt)||this.a>1200)&&(this.initialise(),this.a=0)},this.initialise=function(){this.W=0,this.WM=0,this.WF=0,this.I=0,this.M=0,this.bedNet=0,this.u=s.normal(params.u0,Math.sqrt(params.sigma))}}function Model(a){this.sU=0,this.sB=0,this.sN=0,this.people=new Array,this.n=a,this.bedNetInt=0,this.ts=[],this.Ms=[],this.Ws=[],this.Ls=[];for(var b=0;b<a;b++)this.people.push(new Person(params.a,params.b));this.saveOngoing=function(a,b,c,d){d=1-Math.exp(-d),this.ts.push(a),this.Ms.push(100*b),this.Ws.push(100*c),this.Ls.push(100*d)},this.L3=function(){for(var a=0,b=0,c=0;c<this.n;c++)a+=this.people[c].b*L3Uptake(this.people[c].M),b+=this.people[c].b;return a/=b,a*(1+this.bedNetInt*params.covN*(params.sN-1))*params.lbda*params.g/(params.sig+params.lbda*params.psi1)},this.prevalence=function(){for(var a=0,b=0;b<this.n;b++)a+=s.random()<1-Math.exp(-this.people[b].M);return a/this.n},this.aPrevalence=function(){for(var a=0,b=0;b<this.n;b++)a+=this.people[b].W>0;return a/this.n},this.MDAEvent=function(){for(var a=0;a<this.n;a++)s.normal(this.people[a].u,1)<0&&(this.people[a].M=params.mfPropMDA*this.people[a].M,this.people[a].WM=Math.floor(params.wPropMDA*this.people[a].WM),this.people[a].WF=Math.floor(params.wPropMDA*this.people[a].WF))},this.bedNetEvent=function(){params.sig=params.sig+params.lbda*params.dN*params.covN;for(var a=0;a<this.n;a++)s.random()<params.covN?this.people[a].bedNet=1:this.people[a].bedNet=0},this.nRounds=function(){for(var a=[],b=0;b<this.Ms.length;b++)this.Ms[b]<1&&a.push(b);return 12==params.mdaFreq?Math.floor(this.ts[a[0]]):Math.floor(2*this.ts[a[0]])},this.reduction=function(a){var b=6*a;return this.Ms[b]/this.Ms[0]},this.reductionYears=function(){for(var a=[],b=0;b<20;b++)a.push(this.reduction(b));return a},this.evolveAndSaves=function(a){var e,b=0,c=0,d=1200;this.bedNetInt=0;for(var f=0;f<this.n;f++)this.people[f].M=1;for(d=1200+params.nMDA*params.mdaFreq,e=1==params.IDAControl?1200+5*params.mdaFreq:2*d,console.log("mosquito species: ",params.mosquitoSpecies,"\n"),params.L3=5,console.log("0----------100\n-");b<12*a;){b<960?params.dt=12:params.dt=1;for(var f=0;f<this.n;f++)this.people[f].react();b=this.people[0].t,b<960?params.L3=2:params.L3=this.L3(),b%2==0&&b<Math.floor(b)+params.dt&&this.saveOngoing(b/12,this.prevalence(),this.aPrevalence(),params.L3),Math.floor(b)%Math.floor(12*a/10)==0&&b<Math.floor(b)+params.dt&&(console.log("-"),$("#test1").append(" p : "+this.prevalence()+" t : "+b/12)),b>=1200&&b<1200+params.dt&&(console.log("bednet event at ",b),this.bedNetEvent(),this.bedNetInt=1),b%params.mdaFreq==0&&b<Math.floor(b)+params.dt&&(b>1200&&b<=d?(this.MDAEvent(),setBR(!0),setVH(!0),setMu(!0)):(setBR(!1),setVH(!1),setMu(!1))),c++}this.Ws=this.Ws.slice(200,this.Ws.length),this.Ms=this.Ms.slice(200,this.Ms.length),this.Ls=this.Ls.slice(200,this.Ls.length);var g=this.ts[200];this.ts=math.subtract(this.ts.slice(200,this.ts.length),g)}}function NormSInv(a){var y,z,A,b=-39.6968302866538,c=220.946098424521,d=-275.928510446969,e=138.357751867269,f=-30.6647980661472,g=2.50662827745924,h=-54.4760987982241,i=161.585836858041,j=-155.698979859887,k=66.8013118877197,l=-13.2806815528857,m=-.00778489400243029,n=-.322396458041136,o=-2.40075827716184,p=-2.54973253934373,q=4.37466414146497,r=2.93816398269878,s=.00778469570904146,t=.32246712907004,u=2.445134137143,v=3.75440866190742,w=.02425,x=1-w;return a<0||a>1?(console.error("NormSInv: Argument out of range."),A=0):a<w?(y=Math.sqrt(-2*Math.log(a)),A=(((((m*y+n)*y+o)*y+p)*y+q)*y+r)/((((s*y+t)*y+u)*y+v)*y+1)):a<=x?(y=a-.5,z=y*y,A=(((((b*z+c)*z+d)*z+e)*z+f)*z+g)*y/(((((h*z+i)*z+j)*z+k)*z+l)*z+1)):(y=Math.sqrt(-2*Math.log(1-a)),A=-(((((m*y+n)*y+o)*y+p)*y+q)*y+r)/((((s*y+t)*y+u)*y+v)*y+1)),A}function SessionData(){}function ScenarioIndex(){}function clearSession(){bootbox.confirm("Are you sure you want to delete this session? This will remove all scenarios.",function(a){a&&(SessionData.deleteSession(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawScenarioPlot())})}function scenarioComparisonSelectVisibility(){var a=SessionData.retrieveSession(),b=a&&a.scenarios?a.scenarios.length:0;b>0?($("#sel-comp-stat-div").show(),$("#sel-stat-group").show(),$("#main-menu").popover({trigger:"manual"}),$("#main-menu").popover("hide")):($("#sel-comp-stat-div").hide(),$("#sel-stat-group").hide(),$("#main-menu").popover({animation:!0,title:"First time?",content:"Click here and on about for a tutorial.",placement:"bottom",trigger:"manual"}),$("#main-menu").popover("show"),$("#main-menu").click(function(){$("#main-menu").popover("hide")}))}function scenarioRunStats(){var a=ScenarioIndex.getIndex(),b=SessionData.retrieveSession().scenarios[a],d=($.Deferred(),[]),e=[],f=[],d=b.results[0].ts,e=[],g=reductionStatsCalc(b,params.covMDA);e=g.doses,f=g.reduction,console.log(d),console.log(e),SessionData.storeStats({ts:d,prev_reds:f,doses:e,Ws:g.medW,Ms:g.medM,Ls:g.medL}),drawComparisonPlot()}function createScenarioBoxes(){var a=SessionData.retrieveSession(),b=ScenarioIndex.getIndex();n=a&&a.scenarios?a.scenarios.length:0,d3.select("#scenario-button-group").html(""),d3.select("#scenario-tabs").html(""),n>0?($("#mda-table-box, #scenario-panel").show(),$("#first-time-panel").hide(),d3.select("#scenario-button-group").append("a").attr("class","btn btn-primary").attr("id","show-settings").attr("data-toggle","tooltip").attr("data-placement","top").attr("title","Settings").html('<span class="glyphicon glyphicon-cog gylphicon-white"></i>').on("click",function(){$("#settings-modal").modal("show"),drawScenarioPlot(),setmodelParams(),fixInput(),$("#close_scenario").html("Show Scenario"),SessionData.ran(d)?$("#run_scenario").html("Display Scenario"):$("#run_scenario").html("Run Scenario")}),$("#show-settings").tooltip(),d3.select("#scenario-button-group").append("a").attr("class","btn btn-primary").attr("data-toggle","tooltip").attr("data-placement","top").attr("title","Download").html('<span class="glyphicon glyphicon-download-alt gylphicon-white"></i>').attr("id","download").on("click",download),$("#download").tooltip(),d3.select("#scenario-button-group").append("a").attr("class","btn btn-danger").html('<span class="glyphicon glyphicon-remove-circle gylphicon-white"></i>').attr("data-toggle","tooltip").attr("data-placement","top").attr("title","Delete").attr("id","delete_scenario").on("click",function(){bootbox.confirm("Are you sure you want to delete this scenario?",function(a){a&&(SessionData.deleteScenario(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawScenarioPlot())})}),$("#delete_scenario").tooltip()):($("#mda-table-box, #scenario-panel").hide(),$("#first-time-panel").show());for(var c=d3.select("#scenario-tabs").append("ul").attr("class","nav nav-tabs"),d=0;d<n;d++)c.append("li").attr("role","presentation").attr("class",d==b?"active":"").append("a").attr("href","#"+d).html(a.scenarios[d].label).attr("id","scenario-button-"+d).attr("data-scenario-label",a.scenarios[d].label).attr("data-scenario",d).on("click",function(){$(".nav li").removeClass("active"),ScenarioIndex.setIndex($("#"+this.id).data("scenario")),$("#"+this.id).parent().addClass("active"),drawScenarioPlot(),setmodelParams(),fixInput(),$("#close_scenario").html("Show Scenario"),$("#scenario-messages").html('<div class="alert alert-success alert-dismissible" role="alert">  '+$("#"+this.id).data("scenario-label")+" set </div>"),$(this).addClass("active").siblings().removeClass("active"),SessionData.ran(d)?$("#run_scenario").html("Display Scenario"):$("#run_scenario").html("Run Scenario")});n>0?(d3.select("#add-new-scenario").on("click",addScenarioButton),d3.select("#clear-session").on("click",clearSession)):(d3.select("#add-new-scenario").on("click",addScenarioButton),d3.select("#add-new-scenario-first-time").on("click",addScenarioButton),d3.select("#clear-session").on("click",function(){alert("No scenarios to delete.")}))}function drawScenarioPlot(){var a=ScenarioIndex.getIndex(),b=SessionData.retrieveSession().scenarios[a],c=$("#sel-stat").val();b?"mf"==c?timeSeriesPlot("microfilaraemia","mf prevalence (%)","Ms"):"ICT"==c?timeSeriesPlot("antigenaemia","antigen prevalence (%)","Ws"):"L3"==c&&timeSeriesPlot("L3 prevalence","larval prevalence in mosquito (%)","Ls"):d3.select("#map").html("")}function timeSeriesPlot(a,b,c){for(var d=[],e=ScenarioIndex.getIndex(),f=SessionData.retrieveSession().scenarios[e].results,g=SessionData.retrieveSession().scenarios[e].stats[c],h=f.length,i=0;i<h;i++)k={type:"scatter",x:f[i].ts,y:f[i][c],mode:"lines",hoverinfo:"none",line:{color:"rgb(200, 200, 200)",width:1,opacity:.3}},d.push(k);if(k={type:"scatter",x:f[0].ts,y:g,mode:"lines+markers",name:"median",line:{color:"rgb(0, 0, 200)",width:2,opacity:1}},d.push(k),"Ms"==c||"Ws"==c){var j="Ms"==c?1:2,k={x:f[0].ts,y:Array.apply(null,{length:f[0].ts.length}).map(Number.call,function(){return j}),mode:"lines",name:"threshold",text:"pre-TAS threshold",hoverinfo:"text",line:{color:"rgb(0, 0, 0)",dash:"dot",width:4}};d.push(k)}var l={height:500,showlegend:!1,hovermode:"closest",textposition:"top right",xaxis:{title:"time since start of intervention (yrs)",showgrid:!0,zeroline:!1},yaxis:{title:b,showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}};Plotly.newPlot("map",d,l,{displayModeBar:!1})}function drawComparisonPlot(){var a=SessionData.retrieveSession();if(a.scenarios.length>0){var b=$("#sel-comp-stat").val();"doses"==b?drawDosesTimeLine():"rounds"==b?drawMapBoxPlot():"prev"==b&&drawPrevalenceTimeLine()}else d3.select("#map-boxplot").html("")}function drawDosesTimeLine(){for(var a=ScenarioIndex.getIndex(),b=SessionData.retrieveSession(),c=b.scenarios.length,d=[],h={height:500,title:"Doses per year",xaxis:{title:"time since start of intervention (yrs)",showgrid:!0,zeroline:!1},yaxis:{title:"doses per 100,000",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},i=0;i<c;i++){var j=b.scenarios[i].stats.ts,k=b.scenarios[i].stats.doses,l={x:j,y:k,mode:"lines+markers",name:b.scenarios[i].label};d.push(l)}console.log(d),Plotly.newPlot("map-boxplot",d,h,{displayModeBar:!1}),ScenarioIndex.setIndex(a)}function drawPrevalenceTimeLine(){for(var a=ScenarioIndex.getIndex(),b=SessionData.retrieveSession(),c=b.scenarios.length,d=[],h={height:500,xaxis:{title:"time since start of intervention (yrs)",showgrid:!0,zeroline:!1},yaxis:{title:"Reduction in prevalence (%)",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},i=0;i<c;i++){var j=b.scenarios[i].stats.ts,k=b.scenarios[i].stats.prev_reds,l={x:j,y:k,mode:"lines+markers",name:b.scenarios[i].label};d.push(l)}Plotly.newPlot("map-boxplot",d,h,{displayModeBar:!1}),ScenarioIndex.setIndex(a)}function drawMapBoxPlot(){for(var a=SessionData.retrieveSession(),b=a.scenarios.length,c=[],d=0;d<b;d++){var e={y:SessionData.nRounds(d),type:"box",name:a.scenarios[d].label};c.push(e)}var f={height:500,xaxis:{title:"",showgrid:!1,zeroline:!1},yaxis:{title:"Treatment rounds",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}};Plotly.newPlot("map-boxplot",c,f,{displayModeBar:!1})}function median(a){a.sort(function(a,b){return a-b});var b=Math.floor(a.length/2);return a.length%2?a[b]:(a[b-1]+a[b])/2}function numberWithCommas(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function runMapSimulation(){setInputParams({nMDA:40});var a=$("#inputScenarioLabel").val(),b=Number($("#runs").val()),c=[],d=0;fixInput(),$("#map-progress-bar").css("width","0%"),$("#map-progress-bar").show();var e=setInterval(function(){$("#map-progress-bar").css("width",Number(100*d/b)+"%");var f=new Model(800);f.evolveAndSaves(120),c.push(SessionData.convertRun(f,endemicity)),$("#roundsTest").html(100*d/b+"%"),d==b?($("#map-progress-bar").hide(),clearInterval(e),SessionData.storeResults(c,a),scenarioRunStats(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawScenarioPlot(),$("#settings-modal").modal("hide")):d+=1},10)}function reductionStatsCalc(a,b){for(var e,c=a.results.length,d=a.results[0].ts.length,f=new Array(d),g=new Array(d),h=new Array(d),i=new Array(d),j=new Array(d),k=6==params.mdaFreq?2:1,l=0;l<d;l++){f[l]=0,g[l]=0,mM=[],mW=[],mL=[];for(var m=0;m<c;m++)e=prev=a.results[m].Ms[0],red=a.results[m].Ms[l]/e,prev=a.results[m].Ms[l],mM.push(a.results[m].Ms[l]),mW.push(a.results[m].Ws[l]),mL.push(a.results[m].Ls[l]),f[l]+=red,prev>1&&(g[l]+=1e5*b*k);f[l]=100*(1-f[l]/c),g[l]=g[l]/c,h[l]=median(mM),i[l]=median(mW),j[l]=median(mL)}return{reduction:f,doses:g,medM:h,medW:i,medL:j}}function modalConfirmation(a){SessionData.ran(a)?(ScenarioIndex.setIndex(a),$("#settings-modal").modal("hide")):runSimClick()}function addScenarioButton(){var a=SessionData.numScenarios();ScenarioIndex.setIndex(a),SessionData.createNewSession(),$("#scenario-messages").html(""),$("#settings-modal").modal("show"),$("#close_scenario").html("Close"),fixInput(!1)}function runSimClick(){runMapSimulation()}function changeLabel(){var a=$("#inputScenarioLabel").val(),b=ScenarioIndex.getIndex(),c=SessionData.retrieveSession();c.scenarios[b].label=a,SessionData.storeSession(c),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawScenarioPlot(),$("#scenario-label-button").hide(),$("#scenario-messages").html('<div class="alert alert-success alert-dismissible" role="alert">  '+a+" set </div>")}function fixInput(a){var b=ScenarioIndex.getIndex();null==a&&(a=!0),a?($("#MDACoverage").slider("disable"),$("#bedNetCoverage").slider("disable"),$("#insecticideCoverage").slider("disable"),$("#Microfilaricide").slider("disable"),$("#Macrofilaricide").slider("disable"),$("#runs").slider("disable"),$("#sysAdherence").slider("disable"),$("#run_scenario").hide(),$("input:radio[name=mdaSixMonths]").attr("disabled",!0),$("input:radio[name=mdaRegimenRadios]").attr("disabled",!0),$("input:radio[name=speciesRadios]").attr("disabled",!0),$("#endemicity").slider("disable"),$("#labelEditable").attr("is",!0)):($("#runs").slider("enable"),$("#MDACoverage").slider("enable"),$("#sysAdherence").slider("enable"),$("#bedNetCoverage").slider("enable"),$("#insecticideCoverage").slider("enable"),$("#Microfilaricide").slider("enable"),$("#Macrofilaricide").slider("enable"),$("#endemicity").slider("enable"),$("#run_scenario").show(),$("input:radio[name=mdaSixMonths]").attr("disabled",!1),$("input:radio[name=mdaRegimenRadios]").attr("disabled",!1),$("#inputScenarioLabel").attr("disabled",!1).val("Scenario "+(b+1)),$("input:radio[name=speciesRadios]").attr("disabled",!1),$("#labelEditable").attr("is",!1)),5==$("input[name=mdaRegimenRadios]:checked").val()?$("#custom-regimen-sliders").show():$("#custom-regimen-sliders").hide(),$("#scenario-label-button").hide()}function setmodelParams(a){null==a&&(a=!1);var b=ScenarioIndex.getIndex(),c=SessionData.retrieveSession(),d=c.scenarios[b].params.inputs;return $("#inputScenarioLabel").val(c.scenarios[b].label),$("#inputMDARounds").val(d.mda),$("#sysAdherence").val(d.rho),$("#runs").slider("setValue",Number(d.runs)),$("#MDACoverage").slider("setValue",Number(d.coverage)),$("#endemicity").slider("setValue",Number(d.endemicity)),$("#bedNetCoverage").slider("setValue",Number(d.covN)),$("#insecticideCoverage").slider("setValue",Number(d.v_to_hR)),$("input:radio[name=mdaSixMonths]").filter("[value="+d.mdaSixMonths+"]").prop("checked",!0),$("input:radio[name=mdaRegimenRadios]").filter("[value="+d.mdaRegimen+"]").prop("checked",!0),$("input:radio[name=speciesRadios]").filter("[value="+d.species+"]").prop("checked",!0),$("#Microfilaricide").slider("setValue",Number(d.microfilaricide)),$("#Macrofilaricide").slider("setValue",Number(d.macrofilaricide)),{mda:$("#inputMDARounds").val(),mdaSixMonths:$("input:radio[name=mdaSixMonths]:checked").val(),endemicity:$("#endemicity").val(),coverage:$("#MDACoverage").val(),covN:$("#bedNetCoverage").val(),v_to_hR:$("#insecticideCoverage").val(),vecCap:$("#vectorialCapacity").val(),vecComp:$("#vectorialCompetence").val(),vecD:$("#vectorialDeathRate").val(),mdaRegimen:$("input[name=mdaRegimenRadios]:checked").val(),rho:$("#sysAdherence").val(),rhoBComp:$("#brMda").val(),rhoCN:$("#bedNetMda").val(),species:$("input[name=speciesRadios]:checked").val(),macrofilaricide:$("#Macrofilaricide").val(),microfilaricide:$("#Microfilaricide").val()}}function download(){var a=SessionData.retrieveSession().scenarios[ScenarioIndex.getIndex()].label,b=SessionData.retrieveSession().scenarios[ScenarioIndex.getIndex()].results,c=["time (years)","run","microfilaraemia","antigenaemia","mosquito prevalence"].join(","),d="data:text/csv;charset=utf-8,"+c+"\n";b.forEach(function(a,b){a.ts.forEach(function(c,e){dataString=a.ts[e]+","+b+","+a.Ms[e]+","+a.Ws[e]+","+a.Ls[e],d+=dataString+"\n"})});var e=encodeURI(d),f=document.createElement("a");f.setAttribute("href",e),f.setAttribute("download",a+".csv"),document.body.appendChild(f),f.click()}function toggle(a,b){var c=$(b);c.prop("checked")?$(a).show():$(a).hide()}function toggleOff(a,b){var c=$(b);c.prop("checked")?$(a).hide():$(a).show()}function modelParams(){return{mda:$("#inputMDARounds").val(),mdaSixMonths:$("input:radio[name=mdaSixMonths]:checked").val(),endemicity:$("#endemicity").val(),coverage:$("#MDACoverage").val(),covN:$("#bedNetCoverage").val(),v_to_hR:$("#insecticideCoverage").val(),vecCap:$("#vectorialCapacity").val(),vecComp:$("#vectorialCompetence").val(),vecD:$("#vectorialDeathRate").val(),mdaRegimen:$("input[name=mdaRegimenRadios]:checked").val(),rho:$("#sysAdherence").val(),rhoBComp:$("#brMda").val(),rhoCN:$("#bedNetMda").val(),species:$("input[name=speciesRadios]:checked").val(),macrofilaricide:$("#Macrofilaricide").val(),microfilaricide:$("#Microfilaricide").val(),runs:$("#runs").val()}}function mdaDrugName(a){var b="";switch(a){case"1":b="albendazole + ivermectin";break;case"2":b="albendazole + diethylcarbamazine";break;case"3":b="ivermectin";break;case"4":b="ivermectin + diethylcarbamazine + albendazole";break;case"5":b="custom regimen with "+$("#Macrofilaricide").val()+"% macrofilariae reduction, and "+$("#Microfilaricide").val()+"% microfilariae reduction"}return b}function paramSummary(a){void 0===a&&(a=""),str=paramSummaryText(!1),$("#model"+a+" #parameters-summary").text(str)}function paramSummaryText(a){a="undefined"!=typeof a&&a;var b=modelParams(),c="Parameters used in this scenario are : ";return a===!1?(c+=b.mda?b.mda+" rounds ":"no MDA rounds ",b.mda&&(c+="of "+mdaDrugName(b.mdaRegimen)+" MDA "),b.mda&&(c+="True"==b.mdaSixMonths?"occuring every six months ":"occuring annually "),c+=b.mda?"with "+b.coverage+"% coverage. ":". "):(c+=mdaDrugName(b.mdaRegimen),c+=b.mdaSixMonths?" occuring every six months ":" occuring annually ",c+="with "+b.coverage+"% coverage. "),c+="Prevalence of microfilariaemia is on average "+b.endemicity+"%. ",c+="Bed-net coverage is "+b.covN+"% and ",c+="insecticide coverage is "+b.v_to_hR+"%. "}function multiSimCompute(a){void 0===a&&(a=""),setInputParams();var b=new Model(800);b.evolveAndSaves(120),$("#model"+a+" #test-data-result").html(b),$("#pleaseWaitDialog").modal("hide");var c=Number($("#model"+a+" #multiSim").val());$(".progress-bar").css("width","0%").attr("aria-valuenow",0);var d={x:b.ts,y:b.Ms,type:"scatter",name:"run "+c},e={x:b.ts,y:b.Ws,type:"scatter",name:"run "+c},f={x:b.ts,y:b.Ls,type:"scatter",name:"run "+c},g=jQuery.extend({},layout);g.title="microfilariaemia",Plotly.newPlot("model_"+a+"_chart_mf",[d],g,{displayModeBar:!1}),$("#model_"+a+"_chart_mf,#model_"+a+"_chart_wb,#model_"+a+"_chart_L3").on("plotly_beforehover",function(){return!1});var h=jQuery.extend({},layout);h.title="antigenaemia",Plotly.newPlot("model_"+a+"_chart_wb",[e],h,{displayModeBar:!1});var i=jQuery.extend({},layout);i.title="mosquito",Plotly.newPlot("model_"+a+"_chart_L3",[f],i,{displayModeBar:!1}),addNewSim($("#model"+a+" #multiSim").val()-1,a,c)}function addNewSim(a,b,c){if(void 0===b&&(b=""),a>0){setInputParams();var d=new Model(800);d.evolveAndSaves(120);var e={x:d.ts,y:d.Ms,type:"scatter",name:"run "+a},f={x:d.ts,y:d.Ws,type:"scatter",name:"run "+a},g={x:d.ts,y:d.Ls,type:"scatter",name:"run "+a};Plotly.addTraces("model_"+b+"_chart_mf",e),Plotly.addTraces("model_"+b+"_chart_wb",f),Plotly.addTraces("model_"+b+"_chart_L3",g),$(".progress-bar").css("width",100*(c-a+1)/c+"%").attr("aria-valuenow",100*(c-a+1)/c),a--,setTimeout(function(){addNewSim(a,b,c)},500)}else $("#model"+b+" #multiSimLoading").hide()}function runSimulation(a){if(paramSummary(a),$("#model"+a+" #mutliSimCheckBox").prop("checked"))$("#model"+a+" #multiSimLoading").show(),multiSimCompute(a);else{setInputParams();var b=new Model(800);b.evolveAndSaves(120);var c={x:b.ts,y:b.Ms,type:"scatter",name:"microfilariaemia"},d={x:b.ts,y:b.Ws,type:"scatter",name:"antigenaemia"},e={x:b.ts,y:b.Ls,type:"scatter",name:"mosquito"},f=[c,d,e];layout.title="Time Series",Plotly.newPlot("plotlyChart"+a,f,layout,{displayModeBar:!1})}}var s=new Random;immuneRK4Step=function(a,b){var c=params.dt*(a-params.z*b),d=params.dt*(a-params.z*(b+.5*c)),e=params.dt*(a-params.z*(b+.5*d)),f=params.dt*(a-params.z*(b+e));return b+.1666667*(c+2*d+2*e+f)},L3Uptake=function(a){return 0==params.mosquitoSpecies?params.kappas1*Math.pow(1-Math.exp(-params.r1*a/params.kappas1),2):params.kappas1*(1-Math.exp(-params.r1*a/params.kappas1))},expTrunc=function(a,b){return-1/a*Math.log(1-Math.random()*(1-Math.exp(-a*b)))},poisson=function(a){var b=Math.exp(-a),c=1,d=0;do d++,c*=Math.random();while(c>b);return d-1},setBR=function(a){a?(params.lbda=params.lbdaR*params.lbda_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2):(params.lbda=params.lbda_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2)},setVH=function(a){a?(params.v_to_h=params.v_to_hR*params.v_to_h_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2):(params.v_to_h=params.v_to_h_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2)},setMu=function(a){a?params.sig=params.sigR:params.sig=params.sig_original};var params={riskMu1:1,riskMu2:1,riskMu3:1,shapeRisk:.065,mu:.0104,theta:0,gamma:.1,alpha:.58,lbda:10,v_to_h:9,kappas1:4.395,r1:.055,tau:.00167,z:0,nu:0,L3:0,g:.37,sig:5,psi1:.414,psi2:.32,dt:1,lbdaR:1,v_to_hR:1,nMDA:5,mdaFreq:12,covMDA:.65,s2:.00275,mfPropMDA:.05,wPropMDA:.45,rho:.999,mosquitoSpecies:0,rhoBU:0,aWol:0,sigR:5,covN:0,sysCompN:.99,rhoCN:0,IDAControl:0};params.lbda_original=params.lbda,params.v_to_h_original=params.v_to_h,params.sig_original=params.sig,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2,params.a=params.shapeRisk,params.b=1/params.a,params.sN=.03,params.dN=.41,params.sigma=params.rho/(1-params.rho),params.u0=-NormSInv(params.covMDA)*Math.sqrt(1+params.sigma),setPropMDA=function(a){ps=modelParams(),chis=[.99,.95,.99,1,Number(ps.microfilaricide)/100,.99],taus=[.35,.55,.1,1,Number(ps.macrofilaricide)/100,.1],params.mfPropMDA=1-chis[Number(a)-1],params.wPropMDA=1-taus[Number(a)-1]},closest=function(a,b){for(var c,d=0,e=b.length-1;e-d>1;)c=Math.floor((d+e)/2),b[c]<a?d=c:e=c;return a-b[d]<=b[e]-a?d:e},setVHFromPrev=function(a,b){var g,h,c=[3.66666667,4,4.33333333,4.66666667,5,5.55555556,6.11111111,6.66666667,7.22222222,7.77777778,8.33333333,8.88888889,9.44444444,10],d=[3.33333333,3.66666667,4,4.55555556,5.11111111,5.66666667,6.22222222,6.77777778,7.33333333,7.88888889,8.44444444,9,9.5,10,10.5,11],e=[.06232983,.08068697,.07112745,.07718782,.09405936,.09882859,.11038997,.11982386,.12751358,.13604286,.14459468,.15150072,.15736517,.16302997],f=[.0472584,.05289496,.05937815,.06394662,.0715854,.08006637,.09306863,.11225442,.1267763,.13999753,.15040748,.16114762,.16863057,.17532108,.1827041,.18676246];return 0===b?(g=c,h=e):(g=d,h=f),i=closest(a,h),g[i]},setInputParams=function(a){ps=modelParams(),params.inputs=ps,params.runs=Number(ps.runs),params.nMDA=a&&a.nMDA?a.nMDA:Number(ps.mda),params.mdaFreq="True"===ps.mdaSixMonths?6:12;var b=a&&a.endemicity?a.endemicity/100:ps.endemicity/100,c=ps.species;params.v_to_h=Number(setVHFromPrev(b,Number(c))),params.covMDA=Number(ps.coverage/100),params.covN=Number(ps.covN/100),params.v_to_hR=1-Number(ps.v_to_hR/100),params.vecCap=Number(ps.vecCap),params.vecComp=Number(ps.vecComp),params.vecD=Number(ps.vecD),setPropMDA(Number(ps.mdaRegimen)),params.rho=Number(ps.rho),params.rhoBComp=Number(ps.rhoBComp),params.rhoCN=Number(ps.rhoCN),params.species=Number(ps.species),params.mosquitoSpecies=params.species,0==params.species?params.shapeRisk=.065:params.shapeRisk=.08,params.lbda_original=params.lbda,params.v_to_h_original=params.v_to_h,params.sig_original=params.sig,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2,params.a=params.shapeRisk,params.b=1/params.a,params.sigma=params.rho/(1-params.rho),params.u0=-NormSInv(params.covMDA)*Math.sqrt(1+params.sigma)},plot=function(a,b,c,d){b.unshift("worm_burden"),c.unshift("mf_burden"),d.unshift("L3"),a.unshift("tx"),c3.generate({bindto:"#chart",data:{xs:{worm_burden:"tx",mf_burden:"tx",L3:"tx"},columns:[a,b,c,d],names:{worm_burden:"Worm burden",mf_burden:"mf burden",L3:"L3 density"}},axis:{x:{label:"time (years)",tick:{fit:!1}},y:{label:"Prevalence",min:0}},legend:{position:"right"},zoom:{enabled:!0},type:"spline"})};var glob_data,glob_prevs;SessionData.storeResults=function(a,b,c){var d=JSON.parse(localStorage.getItem("sessionData"));null!=d&&null!=d.scenarios||(d={scenarios:[]}),null==b&&(b="Scenario "+(ScenarioIndex.getIndex()+1));var e={params:params,results:a,label:b},f=ScenarioIndex.getIndex();d.scenarios[f]=e,toStore=JSON.stringify(d);try{localStorage.setItem("sessionData",toStore)}catch(a){alert("Too many scenarios to store. Try deleting some.")}return d},SessionData.storeSession=function(a){toStore=JSON.stringify(a),localStorage.setItem("sessionData",toStore)},SessionData.storeStats=function(a){var b=JSON.parse(localStorage.getItem("sessionData")),c=ScenarioIndex.getIndex();b.scenarios[c].stats=a,toStore=JSON.stringify(b),localStorage.setItem("sessionData",toStore)},SessionData.createNewSession=function(){var a=JSON.parse(localStorage.getItem("sessionData"));null!=a&&null!=a.scenarios||(a={scenarios:[]});var b={params:params,results:[]},c=ScenarioIndex.getIndex();a.scenarios[c]=b,toStore=JSON.stringify(a)},SessionData.deleteSession=function(){localStorage.setItem("sessionData",null)},SessionData.retrieveSession=function(){var a=JSON.parse(localStorage.getItem("sessionData"));return a&&a.scenarios&&a.scenarios[0]&&a.scenarios[0].label?a:(a={scenarios:[]},toStore=JSON.stringify(a),localStorage.setItem("sessionData",toStore),a)},SessionData.numScenarios=function(){var a=SessionData.retrieveSession();return null==a||null==a.scenarios?0:a.scenarios.length},SessionData.convertRun=function(a,b){return{ts:a.ts,Ms:a.Ms,Ws:a.Ws,Ls:a.Ls,reductionYears:a.reductionYears(),nRounds:a.nRounds(),endemicity:b}},SessionData.nRounds=function(a){for(var b=SessionData.retrieveSession(),c=b.scenarios[a],d=c.results.length,e=[],f=0;f<d;f++)e.push(c.results[f].nRounds);return e},SessionData.reductions=function(a,b,c){var d=SessionData.retrieveSession(),e=d.scenarios[a],f=e.results.length;red=0;for(var g=0,h=0;h<f;h++)c?e.results[h].endemicity==c&&(red+=e.results[h].reductionYears[b],g+=1):(red+=e.results[h].reductionYears[b],g+=1);return red/g},SessionData.ran=function(a){var b=SessionData.retrieveSession();if(!b)return!1;if(!b.scenarios[a])return!1;var c=b.scenarios[a].results;return c.length>0},SessionData.deleteScenario=function(){var a=ScenarioIndex.getIndex(),b=SessionData.retrieveSession();b.scenarios.splice(a,1);var c=JSON.stringify(b);localStorage.setItem("sessionData",c),ScenarioIndex.setIndex(0)},ScenarioIndex.getIndex=function(){return Number(localStorage.getItem("scenarioIndex"))},ScenarioIndex.setIndex=function(a){try{var b=SessionData.retrieveSession(),c=b.scenarios[a];params=c.params}catch(a){}return localStorage.setItem("scenarioIndex",a)},$(document).ready(function(){$("#map").width();ScenarioIndex.setIndex(0),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawScenarioPlot(),$("#map-progress-bar").hide(),$("#sel-comp-stat").change(drawComparisonPlot),$("#sel-stat").change(drawScenarioPlot),$("#add-new-scenario").on("click",addScenarioButton),$("#run_scenario").on("click",modalConfirmation),$("#inputScenarioLabel").on("input",function(){"true"==$("#labelEditable").attr("is")&&$("#scenario-label-button").show()}),$("#scenario-label-button").on("click",changeLabel),$(".desc").hide(),$("#desc1").show(),$('input:radio[name="mdaRegimenRadios"]').click(function(){console.log(this);var a=$(this).val();$("small.desc").hide(),$("#desc"+a).show()})});var layout={title:"Time-series",xaxis:{title:"Time since start of intervention (yrs)",showgrid:!1,zeroline:!1},yaxis:{title:"Prevalence",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}};$(document).ready(function(){tabCounter=1,roundsScenarioCounter=1,$("#set-mda-regimen").click(function(){$("#mda-table-box .alert").alert("close");var a=$("#mda-form").html(),b=$("#coverage-form").html().replace("%",""),c=!1;if("IVM + ALB"==a)$("#mdaRegimenRadios1").prop("checked",!0);else if("DEC + ALB"==a)$("#mdaRegimenRadios2").prop("checked",!0);else{var d=$("#new-alert").html(),e=modelParams();$("#mda-table-box").append(d),$("#mda-table-box .alert").addClass("alert-warning").append("<strong> Warning! </strong> MDA regimen was not set. Current regimen is "+mdaDrugName(e.mdaRegimen)+". See settings -> MDA tab for details."),c=!0}if($("#MDACoverage").slider("setValue",Number(b)),0==c){var d=$("#new-alert").html();$("#mda-table-box").append(d),$("#mda-table-box .alert").addClass("alert-success").append("<strong> Success! </strong> MDA parameters set. See settings -> MDA tab for details.")}}),$("#test-data").click(function(){if(paramSummary(),$("#pleaseWaitDialog").modal("show"),$("#model #mutliSimCheckBox").prop("checked"))$("#model #multiSimLoading").show(),multiSimCompute();else{setInputParams();var a=new Model(800);a.evolveAndSaves(120),console.log("No. rounds: ",a.nRounds());var b={x:a.ts,y:a.Ms,type:"scatter",name:"microfilariaemia"},c={x:a.ts,y:a.Ws,type:"scatter",name:"antigenaemia"},d={x:a.ts,y:a.Ls,type:"scatter",name:"mosquito"},e=[b,c,d];layout.title="Time Series",Plotly.newPlot("plotlyChart",e,layout,{displayModeBar:!1}),$("#pleaseWaitDialog").modal("hide")}}),$("#reset-rounds").click(function(){Plotly.newPlot("boxplotChart",[]),roundsScenarioCounter=1,$("#rounds-scenario-accordion").html("")}),$("#run-rounds").click(function(){$("#rounds-progress-bar").show(),$("#roundsTest").show(),$("#rounds-progress-bar-bar").css("width","100%").attr("aria-valuenow",100),$("#rounds-progress-bar").css("width","0%"),setInputParams(),params.nMDA=40;var a=$("#roundSims").val(),b=[],c=0,d=setInterval(function(){$("#rounds-progress-bar").css("width",Number(100*c/a)+"%");var e=new Model(800);if(e.evolveAndSaves(120),b.push(e.nRounds()),$("#roundsTest").html(100*c/a+"%"),c==a){$("#rounds-progress-bar").hide(),$("#roundsTest").hide(),clearInterval(d);var f={height:500,xaxis:{title:"",
showgrid:!1,zeroline:!1},yaxis:{title:"Treatment rounds",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},g={y:b,type:"box",name:"scenario "+roundsScenarioCounter};1==roundsScenarioCounter?Plotly.newPlot("boxplotChart",[g],f,{displayModeBar:!1}):Plotly.addTraces("boxplotChart",[g]),roundsScenarioCounter+=1}else c+=1},10),e=$("#new-scenario-accordian").html();$("#rounds-scenario-accordion").append(e),$("#rounds-scenario-accordion #headingOne").attr("id","heading"+roundsScenarioCounter),$("#rounds-scenario-accordion #heading"+roundsScenarioCounter+" a").attr("href","#collapse"+roundsScenarioCounter).attr("aria-controls","collapse"+roundsScenarioCounter).html("Scenario "+roundsScenarioCounter),$("#rounds-scenario-accordion #collapseOne").attr("id","collapse"+roundsScenarioCounter),$("#collapse"+roundsScenarioCounter).attr("aria-labelledby","heading"+roundsScenarioCounter),$("#collapse"+roundsScenarioCounter+" .panel-body").html(paramSummaryText(!0))}),$("#home a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#vector a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#mda a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#rounds a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#model a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#adherence a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#test a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#plus").click(function(){var a=$("<div role='tabpanel' class='tab-pane' id='model"+tabCounter+"'></div>"),b=$("#new-tab").html();$(".tab-content").append(a),$("div.tab-pane#model"+tabCounter).html(b);var c=$("<li role='presentation' "+tabCounter+"><a href='#model"+tabCounter+"' aria-controls='model' role='tab' data-toggle='tab'><button class='close closeTab' type='button' >x</button>Scenario "+tabCounter+" </a></li>");$("#nav-tabs li:last").prev().after(c),$("#model"+tabCounter+" #plotlyChart").attr("id","plotlyChart"+tabCounter),$("#model"+tabCounter+" #chart_mf").attr("id","model_"+tabCounter+"_chart_mf"),$("#model"+tabCounter+" #chart_wb").attr("id","model_"+tabCounter+"_chart_wb"),$("#model"+tabCounter+" #chart_L3").attr("id","model_"+tabCounter+"_chart_L3"),$("#model"+tabCounter+" #multiSim").slider(),$("#model"+tabCounter+" #multiSimSliderDiv").hide(),$("#model"+tabCounter+" #multiSimLoading").hide(),$("#model"+tabCounter+" #mutliSimCheckBox").data("tabIndex",tabCounter),$("#model"+tabCounter+" #simulation-title").html("Scenario "+tabCounter),$("#model"+tabCounter+" #mutliSimCheckBox").bind("click",function(){var a=$(this).data().tabIndex;toggle("#model"+a+" .multiSimGroup",this),toggleOff("#model"+a+" .singleSimGroup",this)}),$("#model"+tabCounter+" #test-data").data("tabIndex",tabCounter),$("#model"+tabCounter+" #test-data").bind("click",function(){var a=$(this).data();runSimulation(a.tabIndex)}),$(".closeTab").bind("click",function(){var a=$(this).parent().attr("href");$(this).parent().parent().remove(),$("#myTab a:last").tab("show"),$(a).remove()}),$("a#model"+tabCounter+" button").data("tabIndex",tabCounter),$('.nav-tabs a[href="#model'+tabCounter+'"]').tab("show"),tabCounter++}),$("#regimen-radio").bind("click",function(){5==$("input[name=mdaRegimenRadios]:checked").val()?$("#custom-regimen-sliders").show():$("#custom-regimen-sliders").hide()}),$("#custom-regimen-sliders").hide(),$("#Macrofilaricide").slider({}),$("#Microfilaricide").slider({}),$("#sysAdherence").slider({}),$("#brMda").slider({}),$("#bedNetMda").slider({}),$("#endemicity").slider({formatter:function(a){return a+"%"}}),$("#roundSims").slider({}),$("#MDACoverage").slider({formatter:function(a){return a+"%"}}),$("#bedNetCoverage").slider({formatter:function(a){return a+"%"}}),$("#insecticideCoverage").slider({formatter:function(a){return a+"%"}}),$("#multiSim").slider(),$("#vectorialCapacity").slider(),$("#vectorialCompetence").slider(),$("#vectorialDeathRate").slider(),$("#multiSimSliderDiv").hide(),$("#multiSimLoading").hide(),$("#rounds-progress-bar").hide(),$("#runs").slider({}),$("#termsModal").modal({show:!0,backdrop:"static",keyboard:!1})});
